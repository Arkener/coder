<?php
define(CODER_OK, 1);
define(CODER_NOT_OK, 0);

class CoderTestCase extends DrupalTestCase {
  function runCoderTests($snippets, $type) {
    foreach ($snippets as $code => $status) {
      // Run the coder review on the code snippet.
      $results = coder_test($code, $type);

      // Display the test results.
      $code = str_replace(array('%s', '%d'), array('%%s', '%%d'), $code);
      if ($status == CODER_OK) {
        if (count($results) == 0) {
          $this->assertTrue(TRUE, 'Expect NO warning: '. $code);
        }
        else {
          $this->assertTrue(FALSE, 'Expect NO warning: '. $code .': '. $this->getWarnings($results));
        }
      }
      else {
        if (count($results) <= 1) {
          $this->assertTrue(count($results) == 1, 'Expect a warning: '. $code);
        }
        else {
          $this->assertTrue(FALSE, 'Expected a warning, but received many: '. $code .': '. $this->getWarnings($results));
        }
      }
    }
  }

  function getWarnings($results) {
    $warnings = array();
    foreach ($results as $error) {
      $warning = _coder_warning($error['rule']);
      if (is_array($warning)) {
        $warning = $warning['#warning'];
      }
      $warnings[] = $warning;
    }
    return implode('; ', $warnings);
  }
}
