<?php
require_once(dirname(__FILE__) .'/coder_test_case.tinc');

class CoderUpgrade6xTest extends CoderTestCase {
  function getInfo() {
    return array(
      'name' => t('Coder Upgrade 6.x Tests'),
      'description' => t('Tests for the coder upgrade6x review.'),
      'group' => 'Coder'
    );
  }
  
  function setUp() {
  }

  function testUpgrade6x() {
    $snippets = array(
      // Form function tests.
      '  function my_module_forms($args) {' => CODER_NOT_OK,
      '  function my_module_forms($form_id, $args) {' => CODER_OK,
      '  drupal_retrieve_form(\'testform\', $form_state);' => CODER_OK,
      '  drupal_retrieve_form(\'testform\');' => CODER_NOT_OK,
      '  drupal_retrieve_form($form_id, $form_state);' => CODER_OK,
      '  drupal_retrieve_form($form_id);' => CODER_NOT_OK,
      '  form_set_value($element, \'value\', $form_state);' => CODER_OK,
      '  form_set_value($element, \'value\');' => CODER_NOT_OK,
      // FAPI tests.
      '  $form[\'#base\'] = \'http://example.com\';' => CODER_NOT_OK,
      '  \'#base\' => \'my_shared_form_id\',' => CODER_NOT_OK,
      '  $form[\'#multistep\'] = TRUE;' => CODER_NOT_OK,
      '  \'#multistep\' => TRUE,' => CODER_NOT_OK,
      '  $form[\'#DANGEROUS_SKIP_CHECK\'] = TRUE;' => CODER_NOT_OK,
      '  \'#DANGEROUS_SKIP_CHECK\' => TRUE,' => CODER_NOT_OK,
      '  $form[\'#pre_render\'][] = \'my_render_function\';' => CODER_OK,
      '  $form[\'#pre_render\'][\'my_render_function\'] = array();' => CODER_NOT_OK,
      '  $form[\'#submit\'][\'my_submit_function\'] = array($param1, $param2);' => CODER_NOT_OK,
      '  $form[\'#submit\'][\'my_validate_function\'] = array();' => CODER_NOT_OK,
      // File handling changes.
      '  if ($file = file_check_upload(\'picture_upload\')) {' => CODER_NOT_OK,
      '  $file = file_save_upload(\'picture_upload\', $destination, FILE_EXISTS_REPLACE); ' => CODER_NOT_OK,
      '  $file = file_save_upload(\'picture_upload\', $dest); ' => CODER_NOT_OK,
      '  $file = file_save_upload(\'picture_upload\', \'abc\'); ' => CODER_NOT_OK,
      '  $file = file_save_upload(\'picture_upload\', "abc"); ' => CODER_NOT_OK,
      '  $file = file_save_upload(\'picture_upload\', array(\'foo\')); ' => CODER_OK,
      '  if ($file = file_save_upload(\'picture_upload\', $validators, $dest)) {' => CODER_OK,
      '  $sql = \'UPDATE {file_revisions} SET vid=1' => CODER_NOT_OK,
      '  if (db_query(\'SELECT * FROM {file_revisions}\')) {' => CODER_NOT_OK,
      // Taxonomy changes.
      '  taxonomy_node_get_terms($nid);' => CODER_NOT_OK,
      '  taxonomy_node_get_terms($node->nid);' => CODER_NOT_OK,
      '  taxonomy_node_get_terms(123);' => CODER_NOT_OK,
      '  taxonomy_node_get_terms($node);' => CODER_OK,
      '  taxonomy_node_get_terms_by_vocabulary($nid);' => CODER_NOT_OK,
      '  taxonomy_node_get_terms_by_vocabulary($node->nid);' => CODER_NOT_OK,
      '  taxonomy_node_get_terms_by_vocabulary(123);' => CODER_NOT_OK,
      '  taxonomy_node_get_terms_by_vocabulary($node);' => CODER_OK,
      '  taxonomy_node_delete($nid);' => CODER_NOT_OK,
      '  taxonomy_node_delete($node->nid);' => CODER_NOT_OK,
      '  taxonomy_node_delete(123);' => CODER_NOT_OK,
      '  taxonomy_node_delete($node);' => CODER_OK,
      '  taxonomy_node_save($nid);' => CODER_NOT_OK,
      '  taxonomy_node_save($node->nid);' => CODER_NOT_OK,
      '  taxonomy_node_save(123);' => CODER_NOT_OK,
      '  taxonomy_node_save($node);' => CODER_OK,
      // format_plural() changes.
      '  strtr(format_plural($num, \'1 %type post\', \'@count %type posts\'), array(\'%type\' => theme(\'placeholder\', $type)));' => CODER_NOT_OK,
      '  format_plural($num, \'1 %type post\', \'@count %type posts\', array(\'%type\' => $type));' => CODER_OK,
      // db_result() changes.
      '  db_result($result, $row);' => CODER_NOT_OK,
      '  db_result($result);' => CODER_OK,
      '  $number = db_result(db_query("SELECT COUNT(*) FROM {flood} WHERE event = \'%s\' AND hostname = \'%s\' AND timestamp > %d", $name, ip_address(), time() - 3600));' => CODER_OK,
      // watchdog() changes.
      '  watchdog(\'debug\', \'My debug message.\');' => CODER_NOT_OK,
      '  watchdog(\'user\', t(\'Removed user.\'));' => CODER_NOT_OK,
      '  watchdog(\'user\', t(\'Removed %username user.\', array(\'%username\' => $user->name)));' => CODER_NOT_OK,
      '  watchdog(\'user\', \'Removed %username user.\', array(\'%username\' => $user->name));' => CODER_OK,
      // drupal_mail() changes.
      '  drupal_mail($action, $to, $subject, $body, $from);' => CODER_NOT_OK,
      '  drupal_mail(\'action_email\', $recipient, $subject, $body, $from);' => CODER_NOT_OK,
      '  drupal_mail(\'action_email\', $account->mail, $subject, $body, $from);' => CODER_NOT_OK,
      '  drupal_mail(\'action_email\', "foo@foo.com", $subject, $body, $from);' => CODER_NOT_OK,
      '  drupal_mail(\'system\', "action_email", $recipient, $language, $params);' => CODER_OK,
      // user_authenticate() changes.
      '  user_authenticate($name, $pass);' => CODER_NOT_OK,
      '  user_authenticate("name", \'pass\');' => CODER_NOT_OK,
      '  user_authenticate($array);' => CODER_OK,
      '  user_authenticate(array(\'name\' => $name, \'pass\' => $pass));' => CODER_OK,
      // cache_set() / cache_get() changes.
      '  cache_set(\'simple_cid\', \'cache\', $simple);' => CODER_NOT_OK,
      '  cache_set(\'simple_cid\', "cache", $simple);' => CODER_NOT_OK,
      '  cache_set(\'simple_cid\', $table, $simple);' => CODER_NOT_OK,
      '  cache_set(\'complex_cid\', $tbl, serialize($complex));' => CODER_NOT_OK,
      '  cache_set(\'complex_cid\', serialize($complex));' => CODER_NOT_OK,
      '  cache_set(\'simple_cid\', $simple);' => CODER_OK,
      '  cache_set(\'simple_cid\', $simple, "cache");' => CODER_OK,
      '  $complex = unserialize(cache_get(\'complex_cid\'));' => CODER_NOT_OK,
      '  $complex = cache_get(\'complex_cid\');' => CODER_OK,
      // Book API tests - deprecated functions.
      '  book_admin_orphan();' => CODER_NOT_OK,
      '  book_content();' => CODER_NOT_OK,
      '  book_form();' => CODER_NOT_OK,
      '  book_insert();' => CODER_NOT_OK,
      '  book_location();' => CODER_NOT_OK,
      '  book_location_down();' => CODER_NOT_OK,
      '  book_node_visitor_html_post();' => CODER_NOT_OK,
      '  book_node_visitor_html_pre();' => CODER_NOT_OK,
      '  book_recurse();' => CODER_NOT_OK,
      '  book_toc_recurse();' => CODER_NOT_OK,
      '  book_tree();' => CODER_NOT_OK,
      '  book_tree_recurse();' => CODER_NOT_OK,
      // Book API tests - function arguments changed.
      '  book_admin_edit($nid);' => CODER_NOT_OK,
      '  book_admin_edit($form_state, $node);' => CODER_OK,
      '  book_toc();' => CODER_NOT_OK,
      '  book_toc($exclude);' => CODER_NOT_OK,
      '  book_toc($bid, array(), $depth);' => CODER_OK,
      '  book_export_html($nid, $depth);' => CODER_NOT_OK,
      '  book_export_html($nid);' => CODER_OK,
      '  book_export();' => CODER_NOT_OK,
      '  book_export($type);' => CODER_NOT_OK,
      '  book_export($type, $nid);' => CODER_OK,
      '  book_outline($nid);' => CODER_NOT_OK,
      '  book_outline($node->nid);' => CODER_NOT_OK,
      '  book_outline($node);' => CODER_OK,
      '  book_prev($node);' => CODER_NOT_OK,
      '  book_prev($book_link);' => CODER_OK,
      '  book_next($node);' => CODER_NOT_OK,
      '  book_next($book_link);' => CODER_OK,
      // Miscellaneous deprecated functions.
      '  locale_refresh_cache();' => CODER_NOT_OK,
      '  db_next_id();' => CODER_NOT_OK,
      '  menu_set_location();' => CODER_NOT_OK,
      '  taxonomy_get_vocabulary($vid);' => CODER_NOT_OK,
      // Miscellaneous variable name and path changes.
      '  custom_url_rewrite($url);' => CODER_NOT_OK,
      '  custom_url_rewrite_inbound($url);' => CODER_OK,
      '  $form_localtion = variable_get(\'comment_form_location\', COMMENT_FORM_SEPARATE_PAGE);' => CODER_NOT_OK,
      '  $form_localtion = variable_set(\'comment_form_location\', COMMENT_FORM_SEPARATE_PAGE);' => CODER_NOT_OK,
      '  $form_localtion = variable_del(\'comment_form_location\');' => CODER_NOT_OK,
      '  $form_localtion = variable_get(\'comment_form_location_page\', COMMENT_FORM_SEPARATE_PAGE);' => CODER_OK,
      '  $variable_name = \'comment_form_location\';' => CODER_NOT_OK,
      '  $variable_name = \'comment_form_location\' . \'_abc\';' => CODER_OK,
      '  $path = \'admin/content/comment/settings\';' => CODER_NOT_OK,
      '  $log_path = \'admin/logs/\';' => CODER_NOT_OK,
      '  $user_access_path = \'admin/user/access\';' => CODER_NOT_OK,
      '  $permission = user_access(\'administer access control\');' => CODER_NOT_OK,
      '  $ip = $_SERVER[\'REMOTE_ADDR\'];' => CODER_NOT_OK,
    );
    $this->runCoderTests($snippets, 'upgrade6x');
  }
}
